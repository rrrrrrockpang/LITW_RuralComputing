<div>
    <h2 class="h3 bolded-blue">
        <span data-i18n="litw-demographics-title"></span>
        <span data-toggle="tooltip" data-placement="right" data-i18n="[title]litw-demographics-title-tip">
            <span class="tip-handler" data-i18n="litw-demographics-title-tip-text"></span>
        </span>
    </h2>
    <span class="text-left" id="requiredMessage" data-i18n="litw-demographics-required"></span>
    </div>
    
    <br>
    
    <div id="demographicsForm" style="text-align: left"></div>

    <span class="bolded-blue bottom-warning" id="fill-motivational-survey" data-i18n='litw-motivation-warning'></span>

    <script type="text/javascript">
        $(document).ready(function() {
            var countries = {};
            $.getJSON('src/i18n/countries-en.json', function(data) { countries = data; }) //TODO: load based on language
            .done( function () {
                    $("#demographicsForm").alpaca({
                        "data": false,
                        "schema": {
                            "description": "LITW Project - Demographics",
                            "type": "object",
                            "properties": {
                                "demographics-retake": {
                                    "title": $.i18n('litw-demographics-retake'),
                                    "enum": ['no', 'yes'],
                                    "required":true
                                },
                                "demographics-age": {
                                    "title": $.i18n('litw-demographics-age'),
                                    "required":true,
                                    "minimum": 18
                                },
                                "demographics-gender": {
                                    "title": $.i18n('litw-demographics-gender'),
                                    "enum": ['female', 'male', 'non-binary', 'no-disclosure', 'other'],
                                    "required":true
                                },
                                "demographics-gender-other": {
                                    "title": $.i18n('litw-demographics-gender-other'),
                                    "required":false
                                },
                                "demographics-education": {
                                    "title": $.i18n('litw-demographics-education'),
                                    "enum": ['no-formal-edu', 'incomplete-primary', 'complete-primary',
                                        'incomplete-sec-high', 'complete-sec-high', 'university-no-degree',
                                        'university-degree', 'incomplete-grad-prof', 'complete-grad-prof'],
                                    "required":true
                                },
                                "demographics-culture": {
                                    "title": $.i18n('litw-demographics-country'),
                                    "enum": Object.keys(countries),
                                    "required":true
                                },
                                "demographics-race": {
                                    "title": $.i18n('litw-demographics-race'),
                                    "enum": ['native', 'asian', 'black', 'latino', 'islander', 'white', 'no-disclosure',
                                        'other'],
                                    "required":false
                                },
                                "demographics-race-other": {
                                    "title": $.i18n('litw-demographics-race-other'),
                                    "required":false
                                }
                            }
                        },
                        "options": {
                            //"hideInitValidationError":true,
                            "fields": {
                                "demographics-retake": {
                                    "type": 'select',
                                    "optionLabels": [$.i18n('litw-demographics-no'), $.i18n('litw-demographics-yes')],
                                    "sort": false,
                                    "fieldClass": "row",
                                    "noneLabel": "--",
                                    "removeDefaultNone": false,
                                    "showMessages": false,
                                    "default": "--"
                                },
                                "demographics-age": {
                                    "type": 'integer',
                                    "fieldClass": "row",
                                    "showMessages": false,
                                    "validator": function(callback) {
                                        let age = this.getValue();
                                        if(age < 18){
                                            callback({
                                                "status": false,
                                                "message": "You need to be 18+"
                                            });
                                            return;
                                        }
                                        callback({
                                            "status": true
                                        });
                                    }
                                },
                                "demographics-gender": {
                                    "type": 'select',
                                    "optionLabels": [$.i18n('litw-demographics-female'),
                                        $.i18n('litw-demographics-male'), $.i18n('litw-demographics-nonbinary'),
                                        $.i18n('litw-demographics-nodisclose'), $.i18n('litw-demographics-other')],
                                    "sort": false,
                                    "fieldClass": "row",
                                    "noneLabel": "--",
                                    "removeDefaultNone": false,
                                    "showMessages": false,
                                    "default": "--"
                                },
                                "demographics-gender-other": {
                                    "type": 'text',
                                    "fieldClass": "row",
                                    "showMessages": false,
                                    "hidden": true
                                },
                                "demographics-education": {
                                    "type": 'select',
                                    "optionLabels": [$.i18n('litw-demographics-education1'),
                                        $.i18n('litw-demographics-education2'), $.i18n('litw-demographics-education3'),
                                        $.i18n('litw-demographics-education4'), $.i18n('litw-demographics-education5'),
                                        $.i18n('litw-demographics-education6'), $.i18n('litw-demographics-education7'),
                                        $.i18n('litw-demographics-education8'), $.i18n('litw-demographics-education9')
                                    ],
                                    "sort": false,
                                    "fieldClass": "row",
                                    "noneLabel": "--",
                                    "removeDefaultNone": false,
                                    "showMessages": false,
                                    "default": "--"
                                },
                                "demographics-culture": {
                                    "type": 'select',
                                    //"helper": $.i18n('litw-demographics-culture-tip'),
                                    "optionLabels": Object.values(countries),
                                    "sort": false,
                                    "fieldClass": "row",
                                    "noneLabel": "--",
                                    "removeDefaultNone": false,
                                    "showMessages": false,
                                    "default": "--",
                                    "allowOptionalEmpty": true
                                },
                                "demographics-race": {
                                    "type": 'checkbox',
                                    "optionLabels": [
                                        $.i18n('litw-demographics-race-native'),
                                        $.i18n('litw-demographics-race-asian'),
                                        $.i18n('litw-demographics-race-black'),
                                        $.i18n('litw-demographics-race-latino'),
                                        $.i18n('litw-demographics-race-islander'),
                                        $.i18n('litw-demographics-race-white'),
                                        $.i18n('litw-demographics-nodisclose'),
                                        $.i18n('litw-demographics-other'),
                                    ],
                                    "sort": false,
                                    "removeDefaultNone": true,
                                    "fieldClass": "row",
                                    "showMessages": false,
                                    "hidden": true
                                },
                                "demographics-race-other": {
                                    "type": 'text',
                                    "fieldClass": "row",
                                    "showMessages": false,
                                    "hidden": true
                                }
                            }
                        },
                        "postRender": function(control){
                            $('#btn-next-page').attr('style','display:none;');
                            $(".alpaca-required-indicator").html(" *");
                            $("input[type='text']").css('width','200px');
                            
                            // AGE RESTRICTION CODE!!!
                            let age = control.childrenByPropertyId["demographics-age"];
                            age.subscribe(age, function(ageValue) {
                                alertMessage = $(`<span id="ageAlert" style="color:red">${$.i18n('litw-demographics-minor-alert1')}</span>`)
                                if(Number(ageValue) < 18) {
                                    $("input[name='demographics-age']").after(alertMessage);
                                } else {
                                    $("#ageAlert").remove();
                                }
                            });
    
                            let gender = control.childrenByPropertyId["demographics-gender"];
                            let genderOther = control.childrenByPropertyId["demographics-gender-other"];
                            genderOther.subscribe(gender, function(val) {
                                this.options.hidden = val !== 'other';
                                this.refresh();
                                $("input[type='text']").css('width','200px');
                            });
    
                            let country = control.childrenByPropertyId["demographics-culture"];
                            let race = control.childrenByPropertyId["demographics-race"];
                            race.subscribe(country, function(val) {
                                this.options.hidden = val !== 'United States';
                                this.refresh();
                            });
    
                            let raceOther = control.childrenByPropertyId["demographics-race-other"];
                            raceOther.subscribe(race, function(val) {
                                this.options.hidden = !val.includes('other');
                                this.refresh();
                                $("input[type='text']").css('width','200px');
                            });
                        },
                        "view": {
                            "callbacks": {
                                "valid": function(control) {
                                    $('#btn-next-page').attr('style','display:block;');
                                },
                                "invalid": function() {
                                    $('#btn-next-page').attr('style','display:none;');
                                }
                            }
                        }
                     });
            });
        });
    </script>
    
    <script>
        $('[data-toggle="tooltip"]').tooltip();
    </script>